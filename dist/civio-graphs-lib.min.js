// civio-graphs-lib v0.1.3 Copyright 2019 Raúl Díaz Poblete
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-selection"),require("lodash"),require("d3-array"),require("d3-axis"),require("d3-format"),require("d3-scale"),require("d3-time"),require("d3-time-format"),require("d3-shape"),require("slugify"),require("d3-collection"),require("d3-interpolate"),require("d3-scale-chromatic"),require("d3-hierarchy")):"function"==typeof define&&define.amd?define(["exports","d3-selection","lodash","d3-array","d3-axis","d3-format","d3-scale","d3-time","d3-time-format","d3-shape","slugify","d3-collection","d3-interpolate","d3-scale-chromatic","d3-hierarchy"],e):e(t["civio-graphs-lib"]=t["civio-graphs-lib"]||{},t.d3Selection,t.lodash,t.d3Array,t.d3Axis,t.d3Format,t.d3Scale,t.d3Time,t.d3TimeFormat,t.d3Shape,t.slugify,t.d3Collection,t.d3Interpolate,t.d3ScaleChromatic,t.d3Hierarchy)}(this,function(t,e,s,i,a,r,h,l,n,o,c,d,u,g,p){"use strict";c=c&&c.hasOwnProperty("default")?c.default:c;const m={point:!1,align:"auto",valign:"top",background:!1};class x{constructor(t,e){this.chart=t,this.config=s.defaults(e,m),this.setup()}setup(){return this.setupElement(),this.setupLabels(),this}setupElement(){return this.el=this.chart.el.append("div").attr("class",this.config.background?"tooltip tooltip-bkg":"tooltip"),this}setupLabels(){return this.el.append("div").attr("class","label x"),this.el.append("div").attr("class","label y"),this}render(){return this.config.point&&(this.point=this.chart.chart.append("circle").attr("class","tooltip-point").attr("display","none").attr("r",4)),this.chart.chart.on("mousemove",this.onMouseMove.bind(this)).on("mouseenter",this.onMouseEnter.bind(this)).on("mouseleave",this.onMouseLeave.bind(this)),this}show(){return this.el.style("opacity",1),this.point&&this.point.attr("display",null),this}hide(){return this.el.style("opacity",0),this.point&&this.point.attr("display","none"),this}setContent(t){return this.setLabel("x",this.chart.tooltipFormatX()(this.chart.x(t))),this.setLabel("y",this.chart.tooltipFormatY()(this.chart.y(t))),this}setLabel(t,e,s=null){return this.el.select(`.label.${t}`).html(e),null!==s&&this.el.select(`.label.${t}`).style("opacity",s?1:0),this}setPosition(t){const{x:e,y:s}=this.chart.getDataPosition(t);return this.point&&this.point.attr("transform",`translate(${e}, ${s})`),this.setPositionX(e,"auto"!==this.config.align?this.config.align:e>this.chart.width/2?"right":"left"),this.setPositionY(s,this.config.valign),this}setPositionX(t,e){"left"===e?this.el.style("left",`${t}px`).style("right","auto").classed("right",!1):"right"===e?this.el.style("right",`${this.chart.width-t}px`).style("left","auto").classed("right",!0):"center"===e&&this.el.style("left",`${t-this.el.node().getBoundingClientRect().width/2}px`).classed("center",!0)}setPositionY(t,e){"top"===e?this.el.style("top",`${t}px`):"bottom"===e&&this.el.style("bottom",`${this.chart.height-t}px`)}onMouseMove(){const t=this.chart.getMouseData(e.event.layerX);return this.currentData!==t&&(this.currentData=t,this.setContent(this.currentData),this.setPosition(this.currentData),this.chart.highlight(this.currentData)),this}onMouseEnter(){return this.show(),this}onMouseLeave(){return this.hide(),this.chart.highlight(null),this.currentData=null,this}}const y={aspectRatio:2,height:null,lang:"es",margin:{top:0,right:0,left:0,bottom:0},axis:{x:!0,y:!0},tooltip:!0};class f{constructor(t,i){if(this.el=e.select(t),0===this.el.size())throw new Error(`Can't find root element ${t}`);this.el.attr("class",this.chartClass()),this.config=s.defaultsDeep(i,y),this.width=0,this.setChart()}setChart(){return this.chart=this.el.append("svg"),this}setup(t){return this.setData(t),this.setFormat(),this.onResize(),this.setScales(),this.setAxis(),this.setRenderer(),this.config.tooltip&&this.setTooltip(),this}setData(t){this.data=t}setFormat(){r.formatDefaultLocale({decimal:"es"===this.config.lang?",":".",thousands:"es"===this.config.lang?".":",",grouping:[3],currency:this.currencyFormat()}),"es"===this.config.lang&&n.timeFormatDefaultLocale({dateTime:"%A, %e de %B de %Y, %X",date:"%d/%m/%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["domingo","lunes","martes","miércoles","jueves","viernes","sábado"],shortDays:["dom","lun","mar","mié","jue","vie","sáb"],months:["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"],shortMonths:["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"]})}setScales(){return this.scaleX=this.getScaleX().domain(this.scaleXDomain()).range(this.scaleXRange()),this.scaleY=this.getScaleY().domain(this.scaleYDomain()).nice().range(this.scaleYRange()),this.bisector=i.bisector(this.x).left,this}setAxis(){return this.config.axis.x&&(this.axisX=(t=>t.attr("class","x axis").attr("transform",`translate(0,${this.height-this.config.margin.bottom})`).call(this.axisRendererX()).call(t=>t.selectAll(".tick line").attr("y1",-this.height+this.config.margin.top+this.config.margin.bottom).attr("y2",0)))),this.config.axis.y&&(this.axisY=(t=>t.attr("class","y axis").attr("transform",`translate(${this.config.margin.left},0)`).call(this.axisRendererY()).call(t=>t.selectAll(".tick line").attr("x1",0).attr("x2",this.width-this.config.margin.left-this.config.margin.right)))),this}setRenderer(){return this}setTooltip(){this.tooltip=new x(this)}render(){return this.config.axis.x&&this.chart.append("g").call(this.axisX),this.config.axis.y&&this.chart.append("g").call(this.axisY),this.tooltip&&this.tooltip.render(),this.setResize(),this}clear(){(this.config.axis.x||this.config.axis.y)&&this.chart.selectAll("g").remove()}setResize(){return window.addEventListener("resize",s.debounce(()=>this.onResize(),150)),this}onResize(){let t=this.el.node().offsetWidth;t!==this.width&&(this.width=t,this.height=this.config.height?this.config.height:Math.round(this.width/this.config.aspectRatio),this.resize())}resize(){return this.chart.attr("width",this.width).attr("height",this.height),this.scaleX&&this.scaleX.range(this.scaleXRange()),this.scaleY&&this.scaleY.range(this.scaleYRange()),this.axisX&&this.chart.select(".x.axis").call(this.axisX),this.axisY&&this.chart.select(".y.axis").call(this.axisY),this}chartClass(){return"chart"}x(t){return t.date}y(t){return t.value}axisRendererX(){return a.axisBottom(this.scaleX).tickSizeOuter(0).tickFormat(this.axisFormatX()).ticks(l.timeYear)}axisRendererY(){return a.axisLeft(this.scaleY).tickFormat(this.axisFormatY()).ticks(this.height/80)}axisFormatX(){return n.timeFormat("%Y")}axisFormatY(){return r.format("d")}tooltipFormatX(){return n.timeFormat("es"===this.config.lang?"%d %B, %Y":"%B %d, %Y")}tooltipFormatY(){return r.format("$,d")}currencyFormat(){return[""," €"]}getScaleX(){return h.scaleTime()}getScaleY(){return h.scaleLinear()}scaleXDomain(){return[this.x(this.data[0]),this.x(this.data[this.data.length-1])]}scaleYDomain(){return i.extent(this.data,this.y)}scaleXRange(){return[this.config.margin.left,this.width-this.config.margin.right]}scaleYRange(){return[this.height-this.config.margin.bottom,this.config.margin.top]}getMouseData(t){const e=this.scaleX.invert(t),s=this.bisector(this.data,e,1),i=this.data[s-1],a=this.data[s];return a&&e-this.x(i)>this.x(a)-e?a:i}getDataPosition(t){const e=this.bisector(this.data,this.x(t)),s=e<this.data.length?this.data[e]:this.data[this.data.length-1];return{x:this.scaleX(this.x(s)),y:this.scaleY(this.y(s))}}highlight(){return this}}class b extends f{setRenderer(){return this.lineRenderer=o.line().defined(t=>!isNaN(this.y(t))).x(t=>this.scaleX(this.x(t))).y(t=>this.scaleY(this.y(t))),this}setTooltip(){this.tooltip=new x(this,{point:!0})}render(){return super.render(),this.line=this.chart.append("path").datum(this.data).attr("class","line").attr("d",this.lineRenderer),this}clear(){return super.clear(),this.chart.selectAll("path").remove(),this}resize(){return super.resize(),this.line&&this.line.attr("d",this.lineRenderer),this}chartClass(){return"chart chart-line"}curve(t){return this.lineRenderer.curve(t),this}}class v extends f{setScales(){return super.setScales(),this.scaleX.padding(this.scaleXPadding()),this.scaleXInvert=h.scaleQuantize().domain(this.scaleX.range()).range(this.scaleX.domain()),this.scaleX.invert=(t=>this.scaleXInvert(t)),this}setTooltip(){this.tooltip=new x(this,{align:"center",valign:"bottom"})}render(){return super.render(),this.renderBars(),this}renderBars(){return this.bars=this.chart.selectAll("rect").data(this.data).enter().append("rect").attr("class",this.barClass.bind(this)).call(this.setBarDimensions.bind(this)),this}setBarDimensions(t){t.attr("x",t=>this.scaleX(this.x(t))).attr("y",t=>this.scaleY(this.y(t))).attr("height",t=>this.scaleY(this.scaleY.domain()[0])-this.scaleY(this.y(t))).attr("width",this.scaleX.bandwidth())}clear(){return super.clear(),this.chart.selectAll("rect").remove(),this}resize(){return super.resize(),this.scaleXInvert&&this.scaleXInvert.domain(this.scaleX.range()),this.bars&&this.bars.call(this.setBarDimensions.bind(this)),this}chartClass(){return"chart chart-bar-vertical"}axisFormatX(){return null}tooltipFormatX(){return t=>t}getScaleX(){return h.scaleBand()}scaleXDomain(){return this.data.map(this.x)}getDataPosition(t){const e=this.bisector(this.data,this.x(t)),s=e<this.data.length?this.data[e]:this.data[this.data.length-1];return{x:this.scaleX(this.x(s))+this.scaleX.bandwidth()/2,y:this.scaleY(this.y(s))}}highlight(t){return this.el.selectAll(".axis.x text").classed("active",!1),this.el.selectAll(".bar").classed("active",!1),t&&(this.el.selectAll(".axis.x text").filter(e=>e===this.x(t)).classed("active",!0),this.el.select(`.bar-${this.x(t)}`).classed("active",!0)),this}barClass(t){return`bar bar-${c(this.x(t).toString().toLowerCase())}`}scaleXPadding(){return.2}}class C extends x{setupLabels(){return this.chart.data.keys.slice(0).reverse().forEach(t=>{this.el.append("div").attr("class",`label ${c(t.toLowerCase())}`)}),this}setContent(t){this.setLabel("x",this.chart.tooltipFormatX()(t[this.chart.key])),this.chart.data.keys.forEach(e=>{this.setLabel(c(e.toLowerCase()),this.chart.tooltipFormatY()(t[e]),t[e]>0)})}setPosition(t){const{x:e,y:s}=this.chart.getDataPosition(t);return this.setPositionX(e,"auto"!==this.config.align?this.config.align:e>this.chart.width/2?"right":"left"),d.keys(s).forEach(t=>{this.el.select(`.label.${t}`).style("bottom",`${this.chart.height-s[t]}px`)}),this}}t.Chart=f,t.AreaChart=class extends b{setRenderer(){return super.setRenderer(),this.areaRenderer=o.area().x(t=>this.scaleX(this.x(t))).y0(this.getAreaRendererY0()).y1(t=>this.scaleY(this.y(t))),this}render(){return super.render(),this.area=this.chart.append("path").datum(this.data).attr("class","area").attr("d",this.areaRenderer),this}resize(){return super.resize(),this.areaRenderer&&this.areaRenderer.y0(this.getAreaRendererY0()),this.area&&this.area.attr("d",this.areaRenderer),this}chartClass(){return"chart chart-area"}curve(t){return super.curve(t),this.areaRenderer.curve(t),this}getAreaRendererY0(){return this.height-this.config.margin.bottom}},t.BarVerticalChart=v,t.LineChart=b,t.StackedBarVerticalChart=class extends v{setup(t,e){return this.key=e,super.setup(t),this}setScales(){return super.setScales(),this.scaleColor=this.getScaleColor(),this.scaleColor&&this.scaleColor.unknown("#ccc").domain(this.scaleColorDomain()).range(this.scaleColorRange()),this}setTooltip(){this.tooltip=new C(this,{align:"center",valign:"bottom"})}setData(t){const e=Object.keys(t[0]).filter(t=>t!==this.key);this.data=o.stack().keys(e).order(o.stackOrderNone).offset(o.stackOffsetNone)(t),this.data.keys=e,this.data.values=t.map(t=>t[this.key])}renderBars(){return this.bars=this.chart.selectAll(".bar-stack").data(this.data).enter().append("g").attr("class",this.barClass.bind(this)),this.scaleColor&&this.bars.attr("color",(t,e)=>this.scaleColor(this.data.keys[e])),this.bars.selectAll(".bar-stack-item").data(t=>t).enter().append("rect").attr("class",this.barItemClass.bind(this)).call(this.setBarDimensions.bind(this)),this}setBarDimensions(t){t.attr("x",(t,e)=>this.scaleX(this.data.values[e])).attr("y",t=>this.scaleY(t[1])).attr("height",t=>this.scaleY(t[0])-this.scaleY(t[1])).attr("width",this.scaleX.bandwidth())}clear(){return super.clear(),this.chart.selectAll("g").remove(),this}resize(){return super.resize(),this.bars&&this.bars.selectAll(".bar-stack-item").call(this.setBarDimensions.bind(this)),this}chartClass(){return"chart chart-stacked-bar-vertical"}scaleXDomain(){return this.data.values}scaleYDomain(){return[0,i.max(this.data,t=>i.max(t,t=>i.max(t)))]}getMouseData(t){const e=this.scaleX.invert(t),s=this.data.values.indexOf(e);return this.data[0][s].data}getDataPosition(t){const e=t[this.key],s={x:this.scaleX(e)+this.scaleX.bandwidth()/2,y:{}},i=this.data.values.indexOf(e);return this.data.keys.forEach((e,a)=>{if(t[e]){const t=this.data[a][i];s.y[c(e.toLowerCase())]=this.scaleY((t[0]+t[1])/2)}}),s}highlight(t){return this.el.selectAll(".axis.x text").classed("active",!1),this.el.selectAll(".bar-stack-item").classed("active",!1),t&&(this.el.selectAll(".axis.x text").filter(e=>e===t[this.key]).classed("active",!0),this.el.selectAll(`.bar-${t[this.key]}`).classed("active",!0)),this}barClass(t){return`bar-stack bar-${c(t.key.toLowerCase())}`}barItemClass(t){return`bar-stack-item bar-${t.data[this.key]}`}getScaleColor(){return h.scaleOrdinal()}scaleColorDomain(){return this.data.keys}scaleColorRange(){return u.quantize(t=>g.interpolateSpectral(.8*t+.1),this.data.keys.length).reverse()}},t.TreemapChart=class extends f{setChart(){return this.chart=this.el.append("div"),this}setTooltip(){}setScales(){return this.treemap=p.treemap().size([this.width,this.height]).round(!0),this.scaleColor=this.getScaleColor(),this.scaleColor&&this.scaleColor.range(this.scaleColorRange()),this}setAxis(){return this}render(){return this.setResize(),this.renderNodes(),this}renderNodes(){this.nodes=this.chart.selectAll("div").data(this.treemap(this.data).leaves()).enter().append("div").attr("class",this.getNodeClass.bind(this)).call(t=>this.setNodeDimension(t)).call(t=>this.setNodeTooltip(t)),this.nodes.append("span").html(this.getNodeTitle),this.nodes.append("div").style("background",t=>this.getNodeColor(t))}clear(){return super.clear(),this.chart.selectAll("div").remove(),this}resize(){return this.treemap&&(this.treemap.size([this.width,this.height]),this.clear(),this.renderNodes()),this.chart.style("height",`${this.height}px`),this}setNodeDimension(t){t.style("top",t=>`${t.y0}px`).style("left",t=>`${100*t.x0/this.width}%`).style("width",t=>`${100*(t.x1-t.x0)/this.width}%`).style("height",t=>`${t.y1-t.y0}px`)}setNodeTooltip(t){t.attr("data-toggle","tooltip").attr("data-html","true").attr("title",t=>this.getNodeTooltipContent(t))}chartClass(){return"chart chart-treemap"}x(t){return t.data.name}y(t){return t.data.value}getScaleColor(){return h.scaleOrdinal()}scaleColorRange(){return g.schemeCategory10}getNodeClass(t){return`node node-${c(this.x(t).toLowerCase())}`}getNodeColor(t){if(this.scaleColor){for(;t.depth>1;)t=t.parent;return this.scaleColor(this.x(t))}return""}getNodeTitle(t){return this.x(t)}getNodeTooltipContent(t){return`<strong>${this.x(t)}</strong><br/>${this.tooltipFormatY()(this.y(t))}`}tile(t){return this.treemap.tile(t),this}},t.Legend=class{constructor(t){this.el=e.select(t).append("div").attr("class","legend")}setup(t,e){return t.forEach(t=>{this.el.append("div").attr("class",`legend-label ${c(t.toLowerCase())}`).html(e?`<span style="background: ${e(t)}"></span> ${t}`:`<span></span> ${t}`)}),this}},t.Tooltip=x,Object.defineProperty(t,"__esModule",{value:!0})});
